# coding=UTF-8
# ex:ts=4:sw=4:et=on

from PySide6.QtCore import Signal
from PySide6.QtWidgets import QWidget, QHBoxLayout, QSlider, QDoubleSpinBox
from PySide6.QtCore import Qt


class QtScaleEntry(QWidget):
    """
    Compound widget: QSlider + QDoubleSpinBox kept in sync.
    Equivalent of the GTK ScaleEntry widget.
    """
    changed = Signal(float)

    def __init__(self, lower=0.0, upper=1.0, step=0.01, page=0.1,
                 digits=2, parent=None):
        super().__init__(parent)
        self._lower = lower
        self._upper = upper
        self._digits = digits
        self._updating = False

        layout = QHBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)

        self._slider = QSlider(Qt.Horizontal, self)
        self._slider.setRange(0, int((upper - lower) / step))
        self._slider.setSingleStep(1)

        self._spinbox = QDoubleSpinBox(self)
        self._spinbox.setRange(lower, upper)
        self._spinbox.setSingleStep(step)
        self._spinbox.setDecimals(digits)

        layout.addWidget(self._slider, stretch=3)
        layout.addWidget(self._spinbox, stretch=1)

        self._step = step
        self._slider.valueChanged.connect(self._on_slider_changed)
        self._spinbox.valueChanged.connect(self._on_spinbox_changed)

    def _on_slider_changed(self, int_val):
        if self._updating:
            return
        self._updating = True
        val = self._lower + int_val * self._step
        self._spinbox.setValue(val)
        self._updating = False
        self.changed.emit(val)

    def _on_spinbox_changed(self, val):
        if self._updating:
            return
        self._updating = True
        int_val = int(round((val - self._lower) / self._step))
        self._slider.setValue(int_val)
        self._updating = False
        self.changed.emit(val)

    def get_value(self):
        return self._spinbox.value()

    def set_value(self, val):
        self._updating = True
        self._spinbox.setValue(float(val))
        int_val = int(round((float(val) - self._lower) / self._step))
        self._slider.setValue(int_val)
        self._updating = False
