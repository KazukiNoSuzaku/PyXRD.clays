# coding=UTF-8
# Qt replacement for the GTK treemodels utils.

import os

from PySide6.QtCore import Qt
from PySide6.QtGui import QStandardItemModel, QStandardItem


def create_treestore_from_directory(directory):
    """
    Create a QStandardItemModel from a directory tree, suitable for use
    with a QComboBox.  Items store the full file path as Qt.UserRole data.
    Non-leaf items (directories) are flagged as non-selectable.
    """
    model = QStandardItemModel()

    # Empty/none option first
    empty_item = QStandardItem("")
    empty_item.setData("", Qt.UserRole)
    model.appendRow(empty_item)

    if not os.path.isdir(directory):
        return model

    def _add_entries(parent_item, root, depth=0):
        try:
            entries = sorted(os.scandir(root), key=lambda e: (not e.is_dir(), e.name))
        except PermissionError:
            return
        for entry in entries:
            if entry.is_dir():
                # Directory header â€“ shown but not selectable
                label = "  " * depth + entry.name + "/"
                dir_item = QStandardItem(label)
                dir_item.setData("", Qt.UserRole)
                dir_item.setFlags(dir_item.flags() & ~Qt.ItemIsEnabled)
                model.appendRow(dir_item)
                _add_entries(parent_item, entry.path, depth + 1)
            else:
                name = "  " * depth + os.path.splitext(entry.name)[0]
                file_item = QStandardItem(name)
                file_item.setData(entry.path, Qt.UserRole)
                model.appendRow(file_item)

    _add_entries(None, directory, 0)
    return model
