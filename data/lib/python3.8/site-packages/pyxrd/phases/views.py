# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

import os as _os
_resource_filename = lambda path: _os.path.normpath(
    _os.path.join(_os.path.dirname(_os.path.abspath(__file__)), path))
resource_filename = lambda _n, path: _resource_filename(path)

from matplotlib.figure import Figure
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvasQT

from PySide6.QtWidgets import (
    QWidget, QLabel, QGridLayout, QVBoxLayout,
)
from PySide6.QtCore import Qt

from mvc.adapters.qt_support.widgets import QtScaleEntry
from pyxrd.generic.views import BaseView, HasChildView, DialogView, ObjectListStoreView


class EditPhaseView(HasChildView, BaseView):
    title = "Edit Phases"
    builder = resource_filename(__name__, "ui/phase.ui")
    top = "edit_phase"
    widget_format = "phase_%s"

    csds_view = None
    csds_view_container = widget_format % "CSDS_distribution"

    probabilities_view = None
    probabilities_view_container = widget_format % "probabilities"

    components_view = None
    components_view_container = widget_format % "components"

    def set_csds_view(self, view):
        self.csds_view = view
        if view is not None:
            self._add_child_view(view.get_top_widget(), self[self.csds_view_container])
        return view

    def set_csds_sensitive(self, sens):
        container = self[self.csds_view_container]
        if container is not None:
            container.setEnabled(sens)

    def set_probabilities_view(self, view):
        self.probabilities_view = view
        if view is not None:
            self._add_child_view(view.get_top_widget(), self[self.probabilities_view_container])
        return view

    def remove_probabilities(self):
        tab_widget = self["book_wrapper"]
        container = self[self.probabilities_view_container]
        if tab_widget is not None and container is not None:
            idx = tab_widget.indexOf(container)
            if idx >= 0:
                tab_widget.removeTab(idx)

    def set_components_view(self, view):
        self.components_view = view
        if view is not None:
            self._add_child_view(view.get_top_widget(), self[self.components_view_container])
        return view


class EditRawPatternPhaseView(BaseView):
    title = "Edit Raw Pattern Phase"
    builder = resource_filename(__name__, "ui/raw_pattern_phase.ui")
    top = "edit_raw_pattern_phase"
    widget_format = "rp_phase_%s"


class EditAtomRatioView(DialogView):
    title = "Edit Atom Ratio"
    subview_builder = resource_filename(__name__, "ui/ratio.ui")
    subview_toplevel = "edit_ratio"
    modal = True
    widget_format = "ratio_%s"

    @property
    def atom1_combo(self):
        return self["ratio_atom1"]

    @property
    def atom2_combo(self):
        return self["ratio_atom2"]

    pass  # end of class


class EditAtomContentsView(DialogView):
    title = "Edit Atom Contents"
    subview_builder = resource_filename(__name__, "ui/contents.ui")
    subview_toplevel = "edit_contents"
    modal = True
    widget_format = "contents_%s"

    contents_list_view_container = "atom_contents_container"

    def set_contents_list_view(self, view):
        self[self.widget_format % "atom_contents"] = view
        return self._add_child_view(view, self[self.contents_list_view_container])

    @property
    def atom_contents_container(self):
        return self["container_atom_contents"]

    pass  # end of class


class EditComponentView(HasChildView, BaseView):
    title = "Edit Component"
    builder = resource_filename(__name__, "ui/component.ui")
    top = "edit_component"
    widget_format = "component_%s"

    layer_view = None
    layer_view_container = widget_format % "layer_atoms"

    interlayer_view = None
    interlayer_view_container = widget_format % "interlayer_atoms"

    atom_relations_view = None
    atom_relations_view_container = widget_format % "atom_relations"

    ucpa_view = None
    ucpa_view_container = widget_format % "ucp_a"

    ucpb_view = None
    ucpb_view_container = widget_format % "ucp_b"

    def __init__(self, *args, **kwargs):
        BaseView.__init__(self, *args, **kwargs)

    def set_layer_view(self, view):
        self.layer_view = view
        return self._add_child_view(view, self[self.layer_view_container])

    def set_atom_relations_view(self, view):
        self.atom_relations_view = view
        return self._add_child_view(view, self[self.atom_relations_view_container])

    def set_interlayer_view(self, view):
        self.interlayer_view = view
        return self._add_child_view(view, self[self.interlayer_view_container])

    def set_ucpa_view(self, view):
        self.ucpa_view = view
        return self._add_child_view(view, self[self.ucpa_view_container])

    def set_ucpb_view(self, view):
        self.ucpb_view = view
        return self._add_child_view(view, self[self.ucpb_view_container])


class EditUnitCellPropertyView(BaseView):
    builder = resource_filename(__name__, "ui/unit_cell_prop.ui")
    top = "box_ucf"
    widget_format = "ucp_%s"


class EditCSDSDistributionView(BaseView):
    builder = resource_filename(__name__, "ui/csds.ui")
    top = "tbl_csds_distr"

    def __init__(self, *args, **kwargs):
        BaseView.__init__(self, *args, **kwargs)
        self.graph_parent = self["distr_plot_box"]
        self.setup_matplotlib_widget()

    def setup_matplotlib_widget(self):
        self.figure = Figure(dpi=72)
        self.plot = self.figure.add_subplot(111)
        self.figure.subplots_adjust(bottom=0.20)
        self.matlib_canvas = FigureCanvasQT(self.figure)
        self.plot.autoscale_view()

        container = self.graph_parent
        layout = container.layout()
        if layout is None:
            layout = QVBoxLayout(container)
            layout.setContentsMargins(0, 0, 0, 0)
        layout.addWidget(self.matlib_canvas)
        container.show()

    def update_figure(self, distr):
        self.plot.cla()
        self.plot.hist(
            list(range(len(distr))), len(distr),
            weights=distr, density=True,
            edgecolor='b', histtype='stepfilled'
        )
        self.plot.set_ylabel('')
        self.plot.set_xlabel('CSDS', size=14, weight="heavy")
        self.plot.relim()
        self.plot.autoscale_view()
        if self.matlib_canvas is not None:
            self.matlib_canvas.draw()

    def reset_params(self):
        tbl = self["tbl_params"]
        if tbl is None:
            return
        layout = tbl.layout()
        if layout is not None:
            while layout.count():
                item = layout.takeAt(0)
                w = item.widget()
                if w:
                    w.setParent(None)

    def add_param_widget(self, name, label, minimum, maximum):
        tbl = self["tbl_params"]
        if tbl is None:
            return None
        layout = tbl.layout()
        if not isinstance(layout, QGridLayout):
            layout = QGridLayout(tbl)
            layout.setContentsMargins(0, 0, 0, 0)
            layout.setHorizontalSpacing(6)
            layout.setVerticalSpacing(4)

        row = layout.rowCount()

        lbl = QLabel(label)
        lbl.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
        layout.addWidget(lbl, row, 0)

        inp = QtScaleEntry(minimum, maximum, enforce_range=True)
        layout.addWidget(inp, row, 1)

        tbl.show()
        self[name] = inp
        inp.setObjectName(name)
        return inp


class AddPhaseView(DialogView):
    title = "Add Phase"
    subview_builder = resource_filename(__name__, "ui/addphase.ui")
    subview_toplevel = "add_phase_container"

    active_type = "empty"  # | default | raw

    def __init__(self, *args, **kwargs):
        DialogView.__init__(self, *args, **kwargs)

    def get_G(self):
        return int(self["G"].value())

    def get_R(self):
        return int(self["R"].value())

    def get_phase_type(self):
        if self.active_type == "empty":
            return "empty"
        elif self.active_type == "default":
            combo = self.phase_combo_box
            return combo.currentData() if combo else None
        else:
            return "raw"

    def update_sensitivities(self):
        self["cont_empty_phase"].setEnabled(False)
        self["cont_default_phase"].setEnabled(False)
        if self["rdb_empty_phase"].isChecked():
            self.active_type = "empty"
            self["cont_empty_phase"].setEnabled(True)
        elif self["rdb_default_phase"].isChecked():
            self.active_type = "default"
            self["cont_default_phase"].setEnabled(True)
        else:
            self.active_type = "raw"

    @property
    def phase_combo_box(self):
        return self["cmb_default_phases"]

    pass  # end of class
