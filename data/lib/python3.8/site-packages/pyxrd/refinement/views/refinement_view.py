# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

from pkg_resources import resource_filename  # @UnresolvedImport

from math import isnan

from mvc.adapters.qt_support.widgets.threaded_task_box import QtThreadedTaskBox

from pyxrd.generic.views import DialogView
from pyxrd.generic.utils import not_none

class RefinementView(DialogView):
    title = "Refine Phase Parameters"
    subview_builder = resource_filename(__name__, "ui/refinement.ui")
    subview_toplevel = "refine_params"
    modal = True

    refine_status_builder = resource_filename(__name__, "ui/refine_status.ui")
    refine_status_toplevel = "tbl_refine_info"
    refine_status_container = "refine_status_box"

    refine_spin_container = "refine_spin_box"
    refine_spin_box = None

    refine_method_builder = resource_filename(__name__, "ui/refine_method.ui")
    refine_method_toplevel = "tbl_refine_method"
    refine_method_container = "refine_method_box"

    def __init__(self, *args, **kwargs):
        super(RefinementView, self).__init__(*args, **kwargs)

        # Add the status box
        self._builder.add_from_file(self.refine_status_builder)
        self._add_child_view(self[self.refine_status_toplevel], self[self.refine_status_container])

        # Add the method and options box
        self._builder.add_from_file(self.refine_method_builder)
        self._add_child_view(self[self.refine_method_toplevel], self[self.refine_method_container])

        # Add the refinement thread box
        self.refine_spin_box = QtThreadedTaskBox()
        self._add_child_view(self.refine_spin_box, self[self.refine_spin_container])
        self.hide_refinement_info()

    def connect_cancel_request(self, callback):
        return self.refine_spin_box.connect("cancelrequested", callback)

    def show_refinement_info(self):
        hbox = self["hbox_actions"]
        if hbox is not None:
            hbox.setEnabled(False)
        btn = self["btn_auto_restrict"]
        if btn is not None:
            btn.setEnabled(False)
        method = self[self.refine_method_toplevel]
        if method is not None:
            method.setEnabled(False)
        refinables = self["refinables"]
        if refinables is not None:
            refinables.setVisible(False)

        status = self[self.refine_status_toplevel]
        if status is not None:
            status.show()

    def hide_refinement_info(self):
        status = self[self.refine_status_toplevel]
        if status is not None:
            status.hide()

        hbox = self["hbox_actions"]
        if hbox is not None:
            hbox.setEnabled(True)
        btn = self["btn_auto_restrict"]
        if btn is not None:
            btn.setEnabled(True)
        method = self[self.refine_method_toplevel]
        if method is not None:
            method.setEnabled(True)
        refinables = self["refinables"]
        if refinables is not None:
            refinables.setVisible(True)

    def update_refinement_info(self, current_rp=None, message=None, server_status=None):
        if current_rp is not None and not isnan(current_rp):
            lbl = self["current_residual"]
            if lbl is not None:
                lbl.setText("%.2f" % current_rp)
        lbl_msg = self["message"]
        if lbl_msg is not None:
            lbl_msg.setText(not_none(message, ""))
        self.update_server_status(server_status)

    def update_server_status(self, server_status):
        if server_status is None:
            return
        color, title, descr = server_status
        lbl = self["lbl_server_status"]
        if lbl is not None:
            lbl.setText('<span style="color: %s">%s</span>' % (color, title))
            lbl.setToolTip(descr)

    def update_refinement_status(self, status):
        if self.refine_spin_box is not None:
            self.refine_spin_box.set_status(status)

    def start_spinner(self):
        if self.refine_spin_box is not None:
            self.refine_spin_box.start()

    def stop_spinner(self):
        if self.refine_spin_box is not None:
            self.refine_spin_box.stop()

    pass # end of class
