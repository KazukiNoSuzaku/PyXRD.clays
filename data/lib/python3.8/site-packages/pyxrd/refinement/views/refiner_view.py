# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

from pkg_resources import resource_filename  # @UnresolvedImport

import matplotlib
from matplotlib.figure import Figure
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.backends.backend_qt import NavigationToolbar2QT as NavigationToolbar

from PySide6.QtWidgets import QVBoxLayout

from pyxrd.generic.views import BaseView

class RefinerView(BaseView):
    """
        A view for the Refiner object
    """

    builder = resource_filename(__name__, "ui/refine_results.ui")
    top = "window_refine_results"
    modal = True

    graph_parent = "plot_box"

    def __init__(self, *args, **kwargs):
        BaseView.__init__(self, *args, **kwargs)

        self.graph_parent = self[self.graph_parent]

        self.get_toplevel().setWindowModality(True) if self.get_toplevel() else None

        self.setup_matplotlib_widget()

    def update_labels(self, initial, best, last):
        lbl = self["initial_residual"]
        if lbl is not None:
            lbl.setText("%f" % initial)
        lbl = self["best_residual"]
        if lbl is not None:
            lbl.setText("%f" % best)
        lbl = self["last_residual"]
        if lbl is not None:
            lbl.setText("%f" % last)

    def setup_matplotlib_widget(self):
        self.figure = Figure(dpi=72)

        self.figure.subplots_adjust(bottom=0.20)

        self.canvas = FigureCanvas(self.figure)
        self.toolbar = NavigationToolbar(self.canvas, self.get_top_widget())

        layout = self.graph_parent.layout()
        if layout is None:
            layout = QVBoxLayout(self.graph_parent)
            layout.setContentsMargins(0, 0, 0, 0)
        layout.addWidget(self.toolbar)
        layout.addWidget(self.canvas)
        self.graph_parent.show()

        cdict = {'red': ((0.0, 0.0, 0.0),
                         (0.5, 1.0, 1.0),
                         (1.0, 0.0, 0.0)),
                'green': ((0.0, 0.0, 0.0),
                         (0.5, 1.0, 1.0),
                         (1.0, 0.0, 0.0)),
                'blue': ((0.0, 0.0, 0.0),
                         (0.5, 1.0, 1.0),
                         (1.0, 0.0, 0.0))}
        self.wbw_cmap = matplotlib.colors.LinearSegmentedColormap('WBW', cdict, 256)

    pass # end of class
