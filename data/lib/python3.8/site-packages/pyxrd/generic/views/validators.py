# coding=UTF-8
# ex:ts=4:sw=4:et=on
# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

# Qt replacement for the GTK FloatEntryValidator.
# Uses QDoubleValidator + editingFinished signal instead of GTK entry signals.

from PySide6.QtGui import QDoubleValidator
from PySide6.QtWidgets import QLineEdit


class FloatEntryValidator:
    """
    Attaches float-validation behaviour to a QLineEdit.
    Keeps the last valid value and resets on focus-out if the current text
    is not a valid float.
    """

    def __init__(self, entry):
        self.entry = entry
        self.last_valid_val = 0.0
        self.has_valid_val = True

        validator = QDoubleValidator()
        entry.setValidator(validator)

        entry.editingFinished.connect(self._on_editing_finished)
        entry.textChanged.connect(self._on_text_changed)

    def validate(self, text=None, reset_if_invalid=False):
        if text is None:
            text = self.entry.text()
        try:
            self.last_valid_val = float(text)
            self.has_valid_val = True
        except (ValueError, TypeError):
            self.has_valid_val = False
        if reset_if_invalid and not self.has_valid_val:
            self.entry.blockSignals(True)
            self.entry.setText("%f" % self.last_valid_val)
            self.has_valid_val = True
            self.entry.blockSignals(False)

    def _on_editing_finished(self):
        self.validate(reset_if_invalid=True)

    def _on_text_changed(self, text):
        self.validate(text)
