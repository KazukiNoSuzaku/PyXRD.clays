# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

# Qt replacement for the GTK treeview column / setup helpers.
# The public API (setup_treeview, new_text_column, new_pb_column,
# new_toggle_column, new_combo_column, create_float_data_func,
# reset_columns, PyXRDTreeViewColumn) is kept identical so that
# no controller code needs to change.

from PySide6.QtCore import Qt
from PySide6.QtWidgets import QTreeView, QAbstractItemView, QHeaderView

from .cell_renderer_tools import parse_callback, parse_kwargs

# --------------------------------------------------------------------------
# Selection / sort mode mappings  (same names as GTK)
# --------------------------------------------------------------------------
sel_modes = {
    'NONE':     QAbstractItemView.NoSelection,
    'SINGLE':   QAbstractItemView.SingleSelection,
    'BROWSE':   QAbstractItemView.ContiguousSelection,
    'MULTIPLE': QAbstractItemView.ExtendedSelection,
}

sort_types = {
    'ASCENDING':  Qt.AscendingOrder,
    'DESCENDING': Qt.DescendingOrder,
}


# --------------------------------------------------------------------------
# PyXRDTreeViewColumn  – column descriptor (replaces Gtk.TreeViewColumn)
# --------------------------------------------------------------------------
class PyXRDTreeViewColumn(object):
    """
    Stores column descriptor information for a QTreeView column.
    Provides ``get_col_attr`` for compatibility with data-func patterns.
    """

    def __init__(self, title=None, col_index=0, **col_attrs):
        self.title = title
        self.col_index = col_index
        self._attrs = dict(col_attrs)
        # descriptor dict filled by the new_*_column helpers
        self._desc = {}

    def get_col_attr(self, attr):
        return self._attrs.get(attr, self.col_index)


# --------------------------------------------------------------------------
# Monkey-patch QTreeView.append_column so controllers don't need changes
# --------------------------------------------------------------------------
def _tv_append_column(self, col_desc):
    """
    Apply a column descriptor to this QTreeView.

    The descriptor is a PyXRDTreeViewColumn (or a dict from the new_*_column
    helpers).  Header section properties (visibility, width, resize mode) are
    configured immediately when a model is already attached; otherwise they
    are deferred until setModel() is next called.
    """
    if not hasattr(self, '_pyxrd_columns'):
        self._pyxrd_columns = []
    self._pyxrd_columns.append(col_desc)
    idx = len(self._pyxrd_columns) - 1
    if self.model() is not None:
        _apply_col_desc(self, idx, col_desc)


def _tv_get_columns(self):
    """Return the list of appended PyXRDTreeViewColumn descriptors."""
    return getattr(self, '_pyxrd_columns', [])


def _tv_remove_column(self, col_desc):
    """No-op shim; actual column removal is handled by reset_columns."""
    pass


def _apply_col_desc(tv, idx, col_desc):
    """Configure QHeaderView section *idx* from *col_desc*."""
    header = tv.header()
    if header is None:
        return
    desc = col_desc._desc if isinstance(col_desc, PyXRDTreeViewColumn) else col_desc

    visible = desc.get('visible', True)
    if not visible:
        header.hideSection(idx)
    else:
        header.showSection(idx)

    fixed_width = desc.get('fixed_width', -1)
    if fixed_width >= 0:
        header.setSectionResizeMode(idx, QHeaderView.Fixed)
        header.resizeSection(idx, fixed_width)
    elif desc.get('expand', True):
        header.setSectionResizeMode(idx, QHeaderView.Stretch)
    else:
        header.setSectionResizeMode(idx, QHeaderView.ResizeToContents)

    min_width = desc.get('min_width', -1)
    if min_width >= 0:
        header.setMinimumSectionSize(min_width)


# Attach methods to QTreeView class so all instances get them
QTreeView.append_column = _tv_append_column
QTreeView.get_columns   = _tv_get_columns
QTreeView.remove_column = _tv_remove_column


# --------------------------------------------------------------------------
# Column factory helpers (same signatures as GTK versions)
# --------------------------------------------------------------------------
def _make_col(title, col_type, col_attrs, **desc_extras):
    """Internal: build a PyXRDTreeViewColumn from parsed data."""
    primary_col = col_attrs.get(col_type, 0) if col_attrs else 0
    col = PyXRDTreeViewColumn(title=title, col_index=primary_col, **col_attrs)
    col._desc = dict(col_attrs)
    col._desc['title'] = title
    col._desc['type'] = col_type
    col._desc.update(desc_extras)
    return col


def new_text_column(title,
        edited_callback=None,
        data_func=None,
        spacing=0,
        visible=True,
        resizable=True,
        sizing=1,
        fixed_width=-1,
        min_width=-1,
        max_width=-1,
        expand=True,
        clickable=False,
        alignment=None,
        reorderable=False,
        sort_column_id=-1,
        sort_indicator=False,
        sort_order='ASCENDING',
        **kwargs):
    """Returns a PyXRDTreeViewColumn for a text column."""
    kwargs, col_attrs = parse_kwargs(**kwargs)
    col = _make_col(title, 'text', col_attrs,
                    edited_callback=edited_callback, data_func=data_func,
                    visible=visible, resizable=resizable,
                    fixed_width=fixed_width, min_width=min_width,
                    max_width=max_width, expand=expand)
    return col


def new_pb_column(title,
        data_func=None,
        spacing=0,
        visible=True,
        resizable=True,
        sizing=1,
        fixed_width=-1,
        min_width=-1,
        max_width=-1,
        expand=True,
        clickable=False,
        alignment=None,
        reorderable=False,
        sort_column_id=-1,
        sort_indicator=False,
        sort_order='ASCENDING',
        **kwargs):
    """Returns a PyXRDTreeViewColumn for a pixbuf/decoration column."""
    kwargs, col_attrs = parse_kwargs(**kwargs)
    col = _make_col(title, 'pixbuf', col_attrs,
                    data_func=data_func,
                    visible=visible, resizable=resizable,
                    fixed_width=fixed_width, min_width=min_width,
                    max_width=max_width, expand=expand)
    return col


def new_toggle_column(title,
        data_func=None,
        toggled_callback=None,
        spacing=0,
        visible=True,
        resizable=True,
        sizing=1,
        fixed_width=-1,
        min_width=-1,
        max_width=-1,
        expand=True,
        clickable=False,
        alignment=None,
        reorderable=False,
        sort_column_id=-1,
        sort_indicator=False,
        sort_order='ASCENDING',
        **kwargs):
    """Returns a PyXRDTreeViewColumn for a toggle (checkbox) column."""
    kwargs, col_attrs = parse_kwargs(**kwargs)
    col = _make_col(title, 'toggle', col_attrs,
                    toggled_callback=toggled_callback, data_func=data_func,
                    visible=visible, resizable=resizable,
                    fixed_width=fixed_width, min_width=min_width,
                    max_width=max_width, expand=expand)
    return col


def new_combo_column(title,
        data_func=None,
        changed_callback=None,
        edited_callback=None,
        editing_started_callback=None,
        editing_canceled_callback=None,
        spacing=0,
        visible=True,
        resizable=True,
        sizing=1,
        fixed_width=-1,
        min_width=-1,
        max_width=-1,
        expand=True,
        clickable=False,
        alignment=None,
        reorderable=False,
        sort_column_id=-1,
        sort_indicator=False,
        sort_order='ASCENDING',
        **kwargs):
    """Returns a PyXRDTreeViewColumn for a combo-box column."""
    kwargs, col_attrs = parse_kwargs(**kwargs)
    col = _make_col(title, 'combo', col_attrs,
                    changed_callback=changed_callback,
                    edited_callback=edited_callback, data_func=data_func,
                    visible=visible, resizable=resizable,
                    fixed_width=fixed_width, min_width=min_width,
                    max_width=max_width, expand=expand)
    return col


# --------------------------------------------------------------------------
# Float data-func helper
# --------------------------------------------------------------------------
def create_float_data_func(attribute='text', fmt="%.5f", invalid="#NA#"):
    """
    Returns a callable ``(column, cell, model, itr, args)`` compatible
    with both the GTK and Qt data-func signatures.

    In the Qt model pipeline the cell argument is a QStyledItemDelegate
    (or None).  The function sets a ``_rendered_text`` attribute on *cell*
    that can be picked up by a custom delegate's paint() method.
    For the most common case – where the column uses Qt.DisplayRole – the
    return value is also the formatted string.
    """
    def float_renderer(column, cell, model, itr, args=None):
        col_idx = column.get_col_attr(attribute)
        # itr may be a QModelIndex (Qt) or a Gtk.TreeIter (legacy)
        if hasattr(itr, 'row'):   # QModelIndex
            idx = model.index(itr.row(), col_idx)
            nr = model.data(idx, Qt.DisplayRole)
        else:                      # legacy / pure-Python path
            try:
                nr = model.get_value(itr, col_idx)
            except Exception:
                nr = None
        try:
            text = fmt % float(nr)
        except (TypeError, ValueError):
            text = invalid
        if cell is not None:
            try:
                cell.set_property('text', text)   # GTK delegate shim
            except Exception:
                cell._rendered_text = text        # Qt delegate shim
        return text
    return float_renderer


# --------------------------------------------------------------------------
# Tree-view setup helpers
# --------------------------------------------------------------------------
def reset_columns(tv):
    """Remove all appended column descriptors and reset the header."""
    tv._pyxrd_columns = []
    header = tv.header()
    if header is not None:
        header.reset()


def setup_treeview(tv, model,
        reset=False,
        on_cursor_changed=None,
        on_selection_changed=None,
        sel_mode='SINGLE'):
    """
    Configure a QTreeView: set model, selection mode, and connect signals.

    Returns a list of connection IDs (for compatibility; in Qt these are
    opaque objects rather than integer handler IDs).
    """
    try:
        mode = sel_modes[sel_mode]
    except KeyError as err:
        raise ValueError("Invalid value '%s' for selection mode!" % sel_mode) from err

    if reset:
        reset_columns(tv)

    tv.setModel(model)
    tv.setSelectionMode(mode)

    # Re-apply any column descriptors that were appended before setModel()
    for idx, col_desc in enumerate(getattr(tv, '_pyxrd_columns', [])):
        _apply_col_desc(tv, idx, col_desc)

    ids = []
    if on_cursor_changed is not None:
        conn = tv.clicked.connect(lambda idx, _cb=on_cursor_changed: _cb(tv))
        ids.append(conn)
    if on_selection_changed is not None:
        sel_model = tv.selectionModel()
        if sel_model is not None:
            conn = sel_model.selectionChanged.connect(
                lambda sel, desel, _cb=on_selection_changed: _cb(sel_model)
            )
            ids.append(conn)
    return ids
