# coding=UTF-8
# ex:ts=4:sw=4:et=on

# Copyright (c) 2013, Mathijs Dumon
# All rights reserved.
# Complete license can be found in the LICENSE file.

from pkg_resources import resource_filename  # @UnresolvedImport

from PySide6.QtWidgets import (
    QApplication, QVBoxLayout, QMessageBox, QDialog,
    QLabel, QVBoxLayout as _VBox,
)
from PySide6.QtCore import Qt

from pyxrd.data import settings

from pyxrd.generic.views import ObjectListStoreView, BaseView, HasChildView, FormattedTitleView

from pyxrd.project.views import ProjectView
from pyxrd.specimen.views import SpecimenView, EditMarkersView
from pyxrd.application.icons import get_icon_list


class AppView(HasChildView, FormattedTitleView):
    """
    The main application interface view.
    """
    builder = resource_filename(__name__, "ui/application.ui")
    top = "main_window"
    title_format = "PyXRD - %s"

    child_views = {
        "project":    ProjectView,
        "specimen":   SpecimenView,
        "markers":    EditMarkersView,
        "phases":     ObjectListStoreView,
        "atom_types": ObjectListStoreView,
        "behaviours": ObjectListStoreView,
        "mixtures":   ObjectListStoreView,
    }

    # Actions/widgets that are only visible in FULL layout mode
    widget_groups = {
        'full_mode_only': [
            "tbtn_edit_phases",
            "tbtn_edit_atom_types",
            "tbtn_edit_mixtures",
            "tbtn_separator1",
            "btn_sample",
            "separator3",
            "separator4",
            "separator5",
            "main_menu_item_edit_phases",
            "main_menu_item_edit_atom_types",
            "main_menu_item_edit_mixtures",
        ]
    }

    # --------------------------------------------------------------------------
    #   Initialisation
    # --------------------------------------------------------------------------
    def __init__(self, *args, **kwargs):
        super(AppView, self).__init__(*args, **kwargs)

        main_win = self["main_window"]
        if main_win is not None:
            icon = get_icon_list()
            if icon:
                main_win.setWindowIcon(icon)
                QApplication.setWindowIcon(icon)

        self.reset_all_views()
        if not settings.DEBUG:
            top = self.get_top_widget()
            if top is not None:
                top.showMaximized()
        self.set_layout_mode(settings.DEFAULT_LAYOUT)
        top = self.get_top_widget()
        if top is not None:
            top.show()

    # --------------------------------------------------------------------------
    #   Plot canvas wiring
    # --------------------------------------------------------------------------
    def setup_plot(self, plot_controller):
        self.canvas_widget = plot_controller.get_canvas_widget()
        if hasattr(self.canvas_widget, 'setObjectName'):
            self.canvas_widget.setObjectName("matplotlib_box2")
        self["matplotlib_box2"] = self.canvas_widget

        self.nav_toolbar = plot_controller.get_toolbar_widget(self.get_top_widget())
        if hasattr(self.nav_toolbar, 'setObjectName'):
            self.nav_toolbar.setObjectName("navtoolbar")
        self["navtoolbar"] = self.nav_toolbar

        # Insert canvas into matplotlib_box
        mpl_container = self["matplotlib_box"]
        if mpl_container is not None:
            layout = mpl_container.layout()
            if layout is None:
                layout = QVBoxLayout(mpl_container)
                layout.setContentsMargins(0, 0, 0, 0)
            layout.addWidget(self.canvas_widget)
            mpl_container.show()

        # Insert nav toolbar into navtoolbar_box (hidden initially)
        nav_container = self["navtoolbar_box"]
        if nav_container is not None:
            layout = nav_container.layout()
            if layout is None:
                layout = QVBoxLayout(nav_container)
                layout.setContentsMargins(0, 0, 0, 0)
            layout.addWidget(self.nav_toolbar)
        self.nav_toolbar.hide()

    # --------------------------------------------------------------------------
    #   Child view management
    # --------------------------------------------------------------------------
    def reset_child_view(self, view_name, class_type=None):
        existing = getattr(self, view_name, None)
        if existing is not None:
            existing.hide()
            setattr(self, view_name, None)
        if class_type is None:
            class_type = self.child_views[view_name]
        view = class_type(parent=self)
        setattr(self, view_name, view)
        view.set_layout_mode(self.current_layout_state)

        if view_name.lower() == "project":
            self._add_child_view(
                view.specimens_treeview_container,
                self["specimens_container"]
            )
        return view

    def reset_all_views(self):
        for view_name, class_type in self.child_views.items():
            self.reset_child_view(view_name, class_type)

    # --------------------------------------------------------------------------
    #   Sensitivity updates  (Qt: per-widget setEnabled / QAction.setVisible)
    # --------------------------------------------------------------------------
    def _set_action_or_widget_enabled(self, name, enabled):
        """
        Enable/disable a named item — works for QWidget AND QAction objects.
        """
        item = self[name]
        if item is not None:
            item.setEnabled(enabled)

    def update_project_sensitivities(self, project_loaded):
        splitter = self["main_pained"]
        if splitter is not None:
            splitter.setEnabled(project_loaded)
        # Enable/disable the group of project-related actions
        for name in [
            "action_save_project", "action_save_project_as",
            "action_import_specimens",
            "tbtn_edit_phases", "tbtn_edit_atom_types", "tbtn_edit_mixtures",
            "main_menu_item_edit_phases", "main_menu_item_edit_atom_types",
            "main_menu_item_edit_mixtures",
            "action_add_specimen",
        ]:
            self._set_action_or_widget_enabled(name, project_loaded)

    def update_specimen_sensitivities(self, single_specimen_selected,
                                      multiple_specimen_selected):
        for name in [
            "action_del_specimen", "btn_sample",
            "action_remove_bg", "action_save_graph",
        ]:
            self._set_action_or_widget_enabled(
                name, single_specimen_selected)
        # multi-specimen actions
        for name in ["action_refresh_graph"]:
            self._set_action_or_widget_enabled(
                name, single_specimen_selected or multiple_specimen_selected)

    # --------------------------------------------------------------------------
    #   Status bar
    # --------------------------------------------------------------------------
    def update_plot_status(self, angularpos, dspacing, experimental,
                           calculated=None):
        text = ""
        if angularpos is not None:
            text = ("2\u03b8=% 3.2f °    d=% 3.2f nm    "
                    "I<sub>e</sub>=% 5d" % (angularpos, dspacing, experimental))
            if calculated is not None:
                text += "    I<sub>c</sub>=% 5d" % calculated
        lbl = self["lbl_plot_info"]
        if lbl is not None:
            lbl.setText(text)

    # --------------------------------------------------------------------------
    #   Layout mode
    # --------------------------------------------------------------------------
    def set_layout_mode(self, mode):
        super(AppView, self).set_layout_mode(mode)
        for view_name in self.child_views:
            view = getattr(self, view_name, None)
            if view is not None:
                view.set_layout_mode(mode)

    # --------------------------------------------------------------------------
    #   Plot toolbar toggle
    # --------------------------------------------------------------------------
    def show_plot_toolbar(self):
        if hasattr(self, 'nav_toolbar') and self.nav_toolbar is not None:
            self.nav_toolbar.show()

    def hide_plot_toolbar(self):
        if hasattr(self, 'nav_toolbar') and self.nav_toolbar is not None:
            self.nav_toolbar.hide()

    # --------------------------------------------------------------------------
    #   Overrides
    # --------------------------------------------------------------------------
    def show(self, *args, **kwargs):
        BaseView.show(self, *args, **kwargs)

    def get_toplevel(self):
        return self["main_window"]

    pass  # end of class
